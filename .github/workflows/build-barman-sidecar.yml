name: Build Barman Cloud Sidecar
on:
  workflow_dispatch:
    inputs:
      image_name:
        description: "Main image repository (include 'internal' if needed)"
        required: false
        default: "pgedge/plugin-barman-cloud-sidecar-internal"
      ref:
        description: "Git tag or branch from cloudnative-pg/plugin-barman-cloud"
        required: true
        default: "v0.7.0"
      version:
        description: "Version tag (e.g., 0.7.0)"
        required: true
        default: "0.7.0"

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout Barman Cloud source
        uses: actions/checkout@v4
        with:
          repository: cloudnative-pg/plugin-barman-cloud
          ref: ${{ inputs.ref }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Define image variables
        id: vars
        run: |
          IMAGE_NAME="${{ inputs.image_name }}"
          VERSION="${{ inputs.version }}"

          INTERNAL_SUFFIX=""
          if [[ "${IMAGE_NAME}" == *"internal"* ]]; then
            INTERNAL_SUFFIX="-internal"
          fi

          echo "BASE_IMAGE=ghcr.io/pgedge/plugin-barman-cloud-base${INTERNAL_SUFFIX}" >> $GITHUB_ENV
          echo "PLUGIN_IMAGE=ghcr.io/pgedge/plugin-barman-cloud-plugin${INTERNAL_SUFFIX}" >> $GITHUB_ENV
          echo "SIDECAR_IMAGE=ghcr.io/${IMAGE_NAME}" >> $GITHUB_ENV
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "INTERNAL_SUFFIX=${INTERNAL_SUFFIX}" >> $GITHUB_ENV

      # -------------------------------
      # Check if base image Dockerfile exists (removed in v0.11.0+)
      # -------------------------------
      - name: Check for Dockerfile.barmanbase
        id: check_barmanbase
        run: |
          if [ -f "containers/Dockerfile.barmanbase" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Dockerfile.barmanbase not found - skipping base image build (expected for v0.11.0+)"
          fi

      # -------------------------------
      # Build and push Base and Plugin images
      # -------------------------------
      - name: Build and push Base image
        if: steps.check_barmanbase.outputs.exists == 'true'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: containers/Dockerfile.barmanbase
          push: true
          tags: |
            ${{ env.BASE_IMAGE }}:v${{ env.VERSION }}
            ${{ env.BASE_IMAGE }}:latest
          platforms: linux/amd64,linux/arm64

      - name: Build and push Plugin image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: containers/Dockerfile.plugin
          push: true
          tags: |
            ${{ env.PLUGIN_IMAGE }}:v${{ env.VERSION }}
            ${{ env.PLUGIN_IMAGE }}:latest
          platforms: linux/amd64,linux/arm64

      # -------------------------------
      # After Base + Plugin are built, patch Dockerfiles (only for versions that use base image)
      # -------------------------------
      - name: Patch Dockerfiles to use freshly built images
        if: steps.check_barmanbase.outputs.exists == 'true'
        run: |
          echo "ü©π Updating Dockerfiles to use freshly built pgEdge images..."

          # Patch Plugin reference in Sidecar Dockerfile
          sed -i "s|ghcr.io/cloudnative-pg/plugin-barman-cloud-plugin:[^ ]*|${PLUGIN_IMAGE}:v${VERSION}|g" containers/Dockerfile.sidecar || true
          # Patch Base reference in Plugin and Sidecar Dockerfiles
          sed -i "s|ghcr.io/cloudnative-pg/plugin-barman-cloud-base:[^ ]*|${BASE_IMAGE}:v${VERSION}|g" containers/Dockerfile.plugin containers/Dockerfile.sidecar || true

          echo "‚úÖ Dockerfiles patched successfully"
          echo "--- Updated sidecar Dockerfile ---"
          grep -E "FROM|BASE_IMAGE|PLUGIN_IMAGE" containers/Dockerfile.sidecar || true

      # -------------------------------
      # Build and push Sidecar image
      # -------------------------------
      - name: Build and push Sidecar image (with base image)
        if: steps.check_barmanbase.outputs.exists == 'true'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: containers/Dockerfile.sidecar
          push: true
          build-args: |
            BASE_IMAGE=${{ env.BASE_IMAGE }}:v${{ env.VERSION }}
            PLUGIN_IMAGE=${{ env.PLUGIN_IMAGE }}:v${{ env.VERSION }}
          tags: |
            ${{ env.SIDECAR_IMAGE }}:v${{ env.VERSION }}
            ${{ env.SIDECAR_IMAGE }}:latest
          platforms: linux/amd64,linux/arm64

      - name: Build and push Sidecar image (standalone, v0.11.0+)
        if: steps.check_barmanbase.outputs.exists == 'false'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: containers/Dockerfile.sidecar
          push: true
          tags: |
            ${{ env.SIDECAR_IMAGE }}:v${{ env.VERSION }}
            ${{ env.SIDECAR_IMAGE }}:latest
          platforms: linux/amd64,linux/arm64

      - name: Verify pushed manifest
        run: |
          echo "üîç Verifying sidecar manifest:"
          docker buildx imagetools inspect ${{ env.SIDECAR_IMAGE }}:v${{ env.VERSION }}

