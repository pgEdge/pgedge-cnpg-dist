name: Build kubectl-cnpg Plugin

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'Source repository (owner/repo)'
        required: true
        default: 'cloudnative-pg/cloudnative-pg'
      ref:
        description: 'Tag or branch to build (e.g., v1.27.1 or main)'
        required: true
        default: 'main'
      release_version:
        description: 'Release version for this build (e.g., v1.27.1)'
        required: true
      is_release:
        description: 'Is this a release build? (creates PR to krew-index)'
        required: true
        type: choice
        options:
          - 'false'
          - 'true'
        default: 'false'

env:
  PLUGIN_NAME: cnpg
  ORGANIZATION: ${{ github.repository_owner }}

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.inputs.source_repo }}
          ref: ${{ github.event.inputs.ref }}
          path: source

      - name: Patch source to use pgEdge images
        run: |
          cd source

          echo "=== Patching CloudNativePG source for pgEdge ==="

          VERSION="${{ github.event.inputs.release_version }}"
          VERSION="${VERSION#v}"         # Remove v from version string
          PGEDGE_IMAGE="ghcr.io/pgedge/cloudnative-pg:${VERSION}"
          ORIGINAL_IMAGE_PATTERN="ghcr.io/cloudnative-pg/cloudnative-pg"

          echo "Target image: ${PGEDGE_IMAGE}"

          # Replace image references with version-specific pgEdge image
          # This regex handles both with and without version tags
          find . -type f \( -name "*.go" -o -name "*.yaml" -o -name "*.yml" \) -exec sed -i \
            "s|${ORIGINAL_IMAGE_PATTERN}:[^ \"']*|${PGEDGE_IMAGE}|g; s|${ORIGINAL_IMAGE_PATTERN}\"|${PGEDGE_IMAGE}\"|g; s|${ORIGINAL_IMAGE_PATTERN}'|${PGEDGE_IMAGE}'|g" {} \;

          # Also handle cases without quotes or colons
          find . -type f \( -name "*.go" -o -name "*.yaml" -o -name "*.yml" \) -exec sed -i \
            "s|${ORIGINAL_IMAGE_PATTERN}[^:]|${PGEDGE_IMAGE} |g" {} \;

          echo ""
          echo "=== Verification ==="
          echo "Looking for pgEdge image references:"
          grep -r "ghcr.io/pgedge/cloudnative-pg" --include="*.go" . | head -10 || echo "âš ï¸  No pgEdge references found!"

          echo ""
          echo "Looking for any remaining official image references:"
          grep -r "ghcr.io/cloudnative-pg/cloudnative-pg" --include="*.go" . | head -5 || echo "âœ… All official references replaced"

          echo ""
          echo "âœ… Source patching completed"

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: source/go.mod

      - name: Display build information
        run: |
          echo "================================================"
          echo "BUILD INFORMATION"
          echo "================================================"
          echo "Organization: ${ORGANIZATION}"
          echo "Source Repository: ${{ github.event.inputs.source_repo }}"
          echo "Source Ref: ${{ github.event.inputs.ref }}"
          echo "Release Version: ${{ github.event.inputs.release_version }}"
          echo "Is Release Build: ${{ github.event.inputs.is_release }}"
          echo "Krew Index Repo: ${ORGANIZATION}/${{ vars.KREW_INDEX_REPO_NAME || 'krew-index' }}"
          echo "================================================"
          cd source
          echo "Commit SHA: $(git rev-parse HEAD)"
          echo "Commit Message: $(git log -1 --pretty=%B)"
          echo "================================================"


      - name: Build binaries for multiple platforms
        run: |
          cd source
          VERSION="${{ github.event.inputs.release_version }}"
          BUILD_DIR="${GITHUB_WORKSPACE}/dist"
          mkdir -p "$BUILD_DIR"
          
          echo "Building kubectl-cnpg plugin version ${VERSION}"
          
          # Get build metadata
          BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          COMMIT_SHA=$(git rev-parse HEAD)
          COMMIT_SHORT=$(git rev-parse --short HEAD)
          
          echo "Version: ${VERSION}"
          echo "Commit: ${COMMIT_SHA}"
          echo "Date: ${BUILD_DATE}"
          
          # Plugin path
          PLUGIN_CMD_PATH="./cmd/kubectl-cnpg"
          
          # Check what variables exist in the code
          echo "Checking version variables..."
          grep -n "var.*Version\|var.*Commit\|var.*Date" pkg/versions/versions.go || echo "Variables not found in versions.go"
          
          # Try multiple variable name patterns
          LDFLAGS="-s -w"
          
          # Pattern 1: Capitalized (most common for CloudNativePG)
          LDFLAGS="${LDFLAGS} -X 'github.com/cloudnative-pg/cloudnative-pg/pkg/versions.Version=${VERSION}'"
          LDFLAGS="${LDFLAGS} -X 'github.com/cloudnative-pg/cloudnative-pg/pkg/versions.Commit=${COMMIT_SHA}'"
          LDFLAGS="${LDFLAGS} -X 'github.com/cloudnative-pg/cloudnative-pg/pkg/versions.Date=${BUILD_DATE}'"
          
          # Pattern 2: buildXxx format (backup)
          LDFLAGS="${LDFLAGS} -X 'github.com/cloudnative-pg/cloudnative-pg/pkg/versions.buildVersion=${VERSION}'"
          LDFLAGS="${LDFLAGS} -X 'github.com/cloudnative-pg/cloudnative-pg/pkg/versions.buildCommit=${COMMIT_SHA}'"
          LDFLAGS="${LDFLAGS} -X 'github.com/cloudnative-pg/cloudnative-pg/pkg/versions.buildDate=${BUILD_DATE}'"
          
          echo "LDFLAGS: ${LDFLAGS}"
          
          # Build all platforms
          echo "Building linux/amd64..."
          GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build \
            -ldflags "${LDFLAGS}" \
            -o "${BUILD_DIR}/kubectl-cnpg-linux-amd64" \
            ${PLUGIN_CMD_PATH}
          
          echo "Building linux/arm64..."
          GOOS=linux GOARCH=arm64 CGO_ENABLED=0 go build \
            -ldflags "${LDFLAGS}" \
            -o "${BUILD_DIR}/kubectl-cnpg-linux-arm64" \
            ${PLUGIN_CMD_PATH}
          
          echo "Building darwin/amd64..."
          GOOS=darwin GOARCH=amd64 CGO_ENABLED=0 go build \
            -ldflags "${LDFLAGS}" \
            -o "${BUILD_DIR}/kubectl-cnpg-darwin-amd64" \
            ${PLUGIN_CMD_PATH}
          
          echo "Building darwin/arm64..."
          GOOS=darwin GOARCH=arm64 CGO_ENABLED=0 go build \
            -ldflags "${LDFLAGS}" \
            -o "${BUILD_DIR}/kubectl-cnpg-darwin-arm64" \
            ${PLUGIN_CMD_PATH}
          
          echo "Building windows/amd64..."
          GOOS=windows GOARCH=amd64 CGO_ENABLED=0 go build \
            -ldflags "${LDFLAGS}" \
            -o "${BUILD_DIR}/kubectl-cnpg-windows-amd64.exe" \
            ${PLUGIN_CMD_PATH}
          
          echo "Build completed!"
          ls -lh "${BUILD_DIR}"
          
          # Test one binary to check version info
          echo ""
          echo "Testing version info in linux binary..."
          strings "${BUILD_DIR}/kubectl-cnpg-linux-amd64" | grep -E "1.27.1|${COMMIT_SHORT}|${BUILD_DATE}" | head -5 || echo "Version strings not found"

      - name: Prepare LICENSE and NOTICE for distribution
        id: license_notice
        run: |
          VERSION="${{ github.event.inputs.release_version }}"
          SOURCE_REPO="${{ github.event.inputs.source_repo }}"
          SOURCE_REF="${{ github.event.inputs.ref }}"
          BUILD_DATE=$(date -u +"%Y-%m-%d")
          COMMIT_SHA=$(cd source && git rev-parse HEAD)

          # Copy LICENSE from upstream source
          cp source/LICENSE dist/LICENSE
          echo "âœ… Copied LICENSE from upstream source"

          # Generate NOTICE file documenting modifications
          cat > dist/NOTICE <<EOF
          kubectl-cnpg Plugin
          Copyright (c) 2025-2026, pgEdge, Inc.

          This product includes software developed by the CloudNativePG project
          (https://cloudnative-pg.io/).

          ================================================================================
          Original Work
          ================================================================================

          CloudNativePG kubectl Plugin (kubectl-cnpg)
            Source: https://github.com/${SOURCE_REPO}
            Version: ${SOURCE_REF}
            Commit: ${COMMIT_SHA}
            License: Apache License 2.0
            Copyright: Contributors to CloudNativePG, established as CloudNativePG
                       a Series of LF Projects, LLC.

          ================================================================================
          Modifications by pgEdge, Inc.
          ================================================================================

          Build Date: ${BUILD_DATE}
          Build Version: ${VERSION}

          The following modifications were made to the original CloudNativePG source code
          during the build process, as permitted under the Apache License 2.0:

          1. Default Operator Image Reference Changes
             - Original: ghcr.io/cloudnative-pg/cloudnative-pg
             - Modified: ghcr.io/pgedge/cloudnative-pg:${VERSION#v}

             All default operator image references in the source code have been updated
             to use pgEdge-built and distributed container images. This ensures that
             when users deploy clusters using this plugin, they will use pgEdge's
             validated and supported operator images by default.

          2. Version Metadata Injection
             - Version, commit SHA, and build date have been injected via linker flags
               during compilation to identify this as a pgEdge distribution.

          These modifications do not alter the functionality of the plugin beyond
          changing the default container image registry from the upstream CloudNativePG
          registry to the pgEdge registry.

          ================================================================================
          Apache License 2.0 Notice
          ================================================================================

          This software is distributed under the Apache License 2.0. As required by
          Section 4(b) of the Apache License, this NOTICE file documents the
          modifications made to the original work.

          You may obtain a copy of the License at:
              http://www.apache.org/licenses/LICENSE-2.0

          ================================================================================
          Trademark Notices
          ================================================================================

          CloudNativePG is a Cloud Native Computing Foundation (CNCF) Sandbox project.
          The CloudNativePG name and logos are trademarks of The Linux Foundation.

          This distribution is not affiliated with, endorsed by, or sponsored by the
          CloudNativePG project, the Cloud Native Computing Foundation (CNCF), or
          The Linux Foundation.
          EOF

          echo "âœ… Generated NOTICE file"
          echo ""
          echo "=== NOTICE file contents ==="
          cat dist/NOTICE

      - name: Create archives
        run: |
          cd dist

          echo "Files before archiving:"
          ls -la

          # Create archives with correct internal name, LICENSE, and NOTICE
          for os_arch in linux-amd64 linux-arm64 darwin-amd64 darwin-arm64; do
            binary="kubectl-cnpg-${os_arch}"
            if [ -f "$binary" ]; then
              echo "Creating archive for $binary..."
              # Create temp dir
              mkdir -p temp
              # Copy binary with correct name
              cp "$binary" temp/kubectl-cnpg
              # Copy LICENSE and NOTICE
              cp LICENSE temp/LICENSE
              cp NOTICE temp/NOTICE
              # Create archive from temp dir
              tar czf "${binary}.tar.gz" -C temp kubectl-cnpg LICENSE NOTICE
              # Clean up
              rm -rf temp
              echo "âœ“ Created ${binary}.tar.gz"
            fi
          done

          # Windows
          if [ -f "kubectl-cnpg-windows-amd64.exe" ]; then
            echo "Creating archive for Windows..."
            mkdir -p temp
            cp kubectl-cnpg-windows-amd64.exe temp/kubectl-cnpg.exe
            # Copy LICENSE and NOTICE
            cp LICENSE temp/LICENSE
            cp NOTICE temp/NOTICE
            (cd temp && zip ../kubectl-cnpg-windows-amd64.zip kubectl-cnpg.exe LICENSE NOTICE)
            rm -rf temp
            echo "âœ“ Created kubectl-cnpg-windows-amd64.zip"
          fi

          echo ""
          echo "Archives created:"
          ls -lh *.tar.gz *.zip

          echo ""
          echo "Verifying contents:"
          for archive in *.tar.gz; do
            echo "- $archive:"
            tar -tzf "$archive"
          done

      - name: Generate checksums
        id: checksums
        run: |
          cd dist
          sha256sum * > checksums.txt
          echo "Checksums:"
          cat checksums.txt
          
          # Export checksums as outputs for each platform
          echo "linux_amd64=$(sha256sum kubectl-${PLUGIN_NAME}-linux-amd64.tar.gz | awk '{print $1}')" >> $GITHUB_OUTPUT
          echo "linux_arm64=$(sha256sum kubectl-${PLUGIN_NAME}-linux-arm64.tar.gz | awk '{print $1}')" >> $GITHUB_OUTPUT
          echo "darwin_amd64=$(sha256sum kubectl-${PLUGIN_NAME}-darwin-amd64.tar.gz | awk '{print $1}')" >> $GITHUB_OUTPUT
          echo "darwin_arm64=$(sha256sum kubectl-${PLUGIN_NAME}-darwin-arm64.tar.gz | awk '{print $1}')" >> $GITHUB_OUTPUT
          echo "windows_amd64=$(sha256sum kubectl-${PLUGIN_NAME}-windows-amd64.zip | awk '{print $1}')" >> $GITHUB_OUTPUT

      - name: Get source commit info
        id: source_info
        run: |
          cd source
          echo "commit_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "commit_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Determine release type
        id: release_type
        run: |
          if [ "${{ github.event.inputs.is_release }}" == "true" ]; then
            echo "prerelease=false" >> $GITHUB_OUTPUT
            echo "draft=false" >> $GITHUB_OUTPUT
            echo "tag_suffix=" >> $GITHUB_OUTPUT
          else
            echo "prerelease=true" >> $GITHUB_OUTPUT
            echo "draft=false" >> $GITHUB_OUTPUT
            echo "tag_suffix=-test" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.release_version }}${{ steps.release_type.outputs.tag_suffix }}
          name: kubectl-cnpg ${{ github.event.inputs.release_version }}${{ github.event.inputs.is_release != 'true' && ' (Test Build)' || '' }}
          draft: ${{ steps.release_type.outputs.draft }}
          prerelease: ${{ steps.release_type.outputs.prerelease }}
          body: |
            # kubectl-cnpg Plugin ${{ github.event.inputs.is_release == 'true' && 'Release' || 'Test Build' }}

            **Version:** ${{ github.event.inputs.release_version }}

            **Build Type:** ${{ github.event.inputs.is_release == 'true' && 'ðŸš€ Release Build' || 'ðŸ§ª Test Build' }}

            ## Source Information

            - **Repository:** ${{ github.event.inputs.source_repo }}
            - **Ref:** ${{ github.event.inputs.ref }}
            - **Commit:** ${{ steps.source_info.outputs.commit_sha }}

            ## Modifications from Upstream

            This plugin is built from the official CloudNativePG source with the following modifications:

            1. **Default Operator Image References Changed**
               - Original: `ghcr.io/cloudnative-pg/cloudnative-pg`
               - Modified: `ghcr.io/pgedge/cloudnative-pg:${{ github.event.inputs.release_version }}`

            2. **Version Metadata Injected**
               - Build version, commit SHA, and build date embedded via linker flags

            These modifications ensure the plugin uses pgEdge-built and supported operator images by default.

            ## License & Attribution

            This distribution includes LICENSE and NOTICE files in each archive as required by the Apache License 2.0.

            - **License:** Apache License 2.0
            - **Original Copyright:** Contributors to CloudNativePG, established as CloudNativePG a Series of LF Projects, LLC.

            Each archive contains:
            - `LICENSE` - Apache License 2.0 from upstream CloudNativePG
            - `NOTICE` - Documents all modifications made by pgEdge as required by Apache 2.0 Section 4(b), including:
              - Copyright attribution to both pgEdge and CloudNativePG
              - Documentation of default operator image reference changes
              - Build metadata and version injection details
              - Trademark notices

            ## Installation
            
            ### Via Krew (for release builds)
            
            Add the index:
            
            `kubectl krew index add ${{ env.ORGANIZATION }} https://github.com/${{ env.ORGANIZATION }}/${{ vars.KREW_INDEX_REPO_NAME || 'krew-index' }}.git`
            
            Install the plugin:
            
            `kubectl krew install ${{ env.ORGANIZATION }}/cnpg`
            
            ### Manual Installation
            
            Download the appropriate binary for your platform and add it to your PATH.
            
            #### Linux AMD64
            
            `wget https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.release_version }}${{ steps.release_type.outputs.tag_suffix }}/kubectl-cnpg-linux-amd64.tar.gz`
            
            `tar xzf kubectl-cnpg-linux-amd64.tar.gz`
            
            `sudo mv kubectl-cnpg /usr/local/bin/`
            
            `kubectl cnpg version`
            
            #### macOS (Intel)
            
            `wget https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.release_version }}${{ steps.release_type.outputs.tag_suffix }}/kubectl-cnpg-darwin-amd64.tar.gz`
            
            `tar xzf kubectl-cnpg-darwin-amd64.tar.gz`
            
            `sudo mv kubectl-cnpg /usr/local/bin/`
            
            `kubectl cnpg version`
            
            #### macOS (Apple Silicon)
            
            `wget https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.release_version }}${{ steps.release_type.outputs.tag_suffix }}/kubectl-cnpg-darwin-arm64.tar.gz`
            
            `tar xzf kubectl-cnpg-darwin-arm64.tar.gz`
            
            `sudo mv kubectl-cnpg /usr/local/bin/`
            
            `kubectl cnpg version`
            
            #### Windows
            
            Download the `kubectl-cnpg-windows-amd64.zip` file, extract it, and add to your PATH.
            
            ## Notes

            ${{ github.event.inputs.is_release == 'true' && '- This is an official release build' || '- This is a TEST BUILD for validation only' }}

            ${{ github.event.inputs.is_release == 'true' && '- PR has been created to update the krew-index' || '- No krew-index PR will be created' }}

            ${{ github.event.inputs.is_release == 'true' && '- After krew-index PR is merged, users can install via krew' || '- Use this for testing before creating an official release' }}

            - Each archive contains LICENSE and NOTICE files for Apache 2.0 compliance

            ## Checksums

            See checksums.txt for SHA256 checksums of all artifacts.

            ---

            *This distribution is not affiliated with, endorsed by, or sponsored by the CloudNativePG project, the Cloud Native Computing Foundation (CNCF), or The Linux Foundation.*
          files: |
            dist/*.tar.gz
            dist/*.zip
            dist/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Krew manifest
        if: github.event.inputs.is_release == 'true'
        id: generate_manifest
        run: |
          VERSION="${{ github.event.inputs.release_version }}"
          REPO_NAME="${{ github.event.repository.name }}"
          SOURCE_REPO="${{ github.event.inputs.source_repo }}"
          SOURCE_REF="${{ github.event.inputs.ref }}"
          
          cat > krew-manifest.yaml <<EOF
          # This file is derived from the CloudNativePG project's krew plugin manifest.
          # Modified by pgEdge, Inc. to distribute pgEdge-built binaries.
          # Original source: https://github.com/cloudnative-pg/cloudnative-pg
          # License: Apache License 2.0
          apiVersion: krew.googlecontainertools.github.com/v1alpha2
          kind: Plugin
          metadata:
            name: ${PLUGIN_NAME}
          spec:
            version: ${VERSION}
            homepage: https://github.com/${SOURCE_REPO}
            shortDescription: CloudNativePG kubectl plugin
            description: |
              kubectl plugin for managing CloudNativePG PostgreSQL clusters on Kubernetes.
              
              This plugin provides commands to:
              - Manage PostgreSQL cluster lifecycle
              - Perform backups and restores
              - Monitor cluster status
              - Manage certificates and credentials
              
              Source: https://github.com/${SOURCE_REPO}
              Built from: ${SOURCE_REF}
              Maintained by: ${ORGANIZATION}
            caveats: |
              This plugin requires the CloudNativePG operator to be installed in your cluster.
              
              For more information, visit: https://cloudnative-pg.io
            platforms:
            - selector:
                matchLabels:
                  os: linux
                  arch: amd64
              uri: https://github.com/${ORGANIZATION}/${REPO_NAME}/releases/download/${VERSION}/kubectl-${PLUGIN_NAME}-linux-amd64.tar.gz
              sha256: "${{ steps.checksums.outputs.linux_amd64 }}"
              bin: kubectl-${PLUGIN_NAME}
            - selector:
                matchLabels:
                  os: linux
                  arch: arm64
              uri: https://github.com/${ORGANIZATION}/${REPO_NAME}/releases/download/${VERSION}/kubectl-${PLUGIN_NAME}-linux-arm64.tar.gz
              sha256: "${{ steps.checksums.outputs.linux_arm64 }}"
              bin: kubectl-${PLUGIN_NAME}
            - selector:
                matchLabels:
                  os: darwin
                  arch: amd64
              uri: https://github.com/${ORGANIZATION}/${REPO_NAME}/releases/download/${VERSION}/kubectl-${PLUGIN_NAME}-darwin-amd64.tar.gz
              sha256: "${{ steps.checksums.outputs.darwin_amd64 }}"
              bin: kubectl-${PLUGIN_NAME}
            - selector:
                matchLabels:
                  os: darwin
                  arch: arm64
              uri: https://github.com/${ORGANIZATION}/${REPO_NAME}/releases/download/${VERSION}/kubectl-${PLUGIN_NAME}-darwin-arm64.tar.gz
              sha256: "${{ steps.checksums.outputs.darwin_arm64 }}"
              bin: kubectl-${PLUGIN_NAME}
            - selector:
                matchLabels:
                  os: windows
                  arch: amd64
              uri: https://github.com/${ORGANIZATION}/${REPO_NAME}/releases/download/${VERSION}/kubectl-${PLUGIN_NAME}-windows-amd64.zip
              sha256: "${{ steps.checksums.outputs.windows_amd64 }}"
              bin: kubectl-${PLUGIN_NAME}.exe
          EOF
          
          echo "Generated Krew manifest:"
          cat krew-manifest.yaml

      - name: Upload manifest as artifact
        if: github.event.inputs.is_release == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: krew-manifest
          path: krew-manifest.yaml
          retention-days: 30

      - name: Create PR to Krew Index Repo
        if: github.event.inputs.is_release == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.KREW_INDEX_PAT }}
          script: |
            const fs = require('fs');
            const version = '${{ github.event.inputs.release_version }}';
            const pluginName = process.env.PLUGIN_NAME;
            const organization = process.env.ORGANIZATION;
            const indexRepoName = '${{ vars.KREW_INDEX_REPO_NAME }}' || 'krew-index';
            const indexRepo = `${organization}/${indexRepoName}`;
            const sourceRepo = '${{ github.event.inputs.source_repo }}';
            const sourceRef = '${{ github.event.inputs.ref }}';
            const sourceCommit = '${{ steps.source_info.outputs.commit_short }}';
            
            console.log(`ðŸ“¦ Creating PR to ${indexRepo} for ${pluginName} ${version}`);
            
            const [owner, repo] = indexRepo.split('/');
            
            // Read the manifest
            const manifest = fs.readFileSync('krew-manifest.yaml', 'utf8');
            
            // Get the default branch
            const { data: repoData } = await github.rest.repos.get({
              owner,
              repo
            });
            const defaultBranch = repoData.default_branch;
            console.log(`Default branch: ${defaultBranch}`);
            
            // Get the SHA of the default branch
            const { data: refData } = await github.rest.git.getRef({
              owner,
              repo,
              ref: `heads/${defaultBranch}`
            });
            const baseSha = refData.object.sha;
            
            // Create a new branch
            const branchName = `update-${pluginName}-${version}`;
            console.log(`Creating branch: ${branchName}`);
            
            // Delete branch if it exists
            try {
              await github.rest.git.deleteRef({
                owner,
                repo,
                ref: `heads/${branchName}`
              });
              console.log('ðŸ—‘ï¸  Deleted existing branch');
            } catch (error) {
              console.log('âœ… Branch does not exist yet');
            }
            
            // Create new branch
            await github.rest.git.createRef({
              owner,
              repo,
              ref: `refs/heads/${branchName}`,
              sha: baseSha
            });
            console.log(`âœ… Created branch: ${branchName}`);
            
            // Get current file SHA if it exists
            let currentFileSha;
            try {
              const { data: fileData } = await github.rest.repos.getContent({
                owner,
                repo,
                path: `plugins/${pluginName}.yaml`,
                ref: defaultBranch
              });
              currentFileSha = fileData.sha;
              console.log('ðŸ“ Updating existing manifest file');
            } catch (error) {
              console.log('ðŸ“ Creating new manifest file');
            }
            
            // Create or update the file
            await github.rest.repos.createOrUpdateFileContents({
              owner,
              repo,
              path: `plugins/${pluginName}.yaml`,
              message: `Update ${pluginName} plugin to ${version}`,
              content: Buffer.from(manifest).toString('base64'),
              branch: branchName,
              sha: currentFileSha
            });
            console.log('âœ… Updated manifest file');
            
            // Create pull request
            const { data: pr } = await github.rest.pulls.create({
              owner,
              repo,
              title: `ðŸš€ Update ${pluginName} plugin to ${version}`,
              head: branchName,
              base: defaultBranch,
              body: `
              ## kubectl-cnpg Plugin Release
              
              This PR updates the **${pluginName}** plugin to version **${version}**.
              
              ### ðŸ“‹ Source Information
              - **Repository:** ${sourceRepo}
              - **Ref:** ${sourceRef}
              - **Commit:** ${sourceCommit}
              
              ### âœ… Changes
              - Built from official upstream source
              - Updated plugin version to ${version}
              - Updated download URLs and checksums for all platforms
              - All binaries built and verified
              
              ### ðŸ”— Artifacts
              - Release: https://github.com/${{ github.repository }}/releases/tag/${version}
              - Checksums included for verification
              
              ### ðŸ“¦ Installation
              After merging, users can update with:
              \`\`\`bash
              # Add the index if not already added
              kubectl krew index add ${organization} https://github.com/${indexRepo}.git
              
              # Install or upgrade the plugin
              kubectl krew install ${organization}/${pluginName}
              # Or if already installed:
              kubectl krew upgrade ${pluginName}
              \`\`\`
              
              ### ðŸ§ª Testing
              To test before merging:
              \`\`\`bash
              # Download and install manually
              wget https://github.com/${{ github.repository }}/releases/download/${version}/kubectl-${pluginName}-linux-amd64.tar.gz
              tar xzf kubectl-${pluginName}-linux-amd64.tar.gz
              sudo mv kubectl-${pluginName} /usr/local/bin/
              kubectl ${pluginName} version
              \`\`\`
              
              ---
              *ðŸ¤– This PR was automatically generated by the release workflow.*
              *Built from: ${sourceRepo}@${sourceRef}*
              `
            });
            
            console.log(`âœ… Created PR #${pr.number}: ${pr.html_url}`);
            core.summary.addHeading('PR Created Successfully', 2);
            core.summary.addRaw(`Organization: ${organization}`);
            core.summary.addBreak();
            core.summary.addLink(`PR #${pr.number}`, pr.html_url);
            await core.summary.write();

      - name: Summary
        if: always()
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event.inputs.is_release }}" == "true" ]; then
            echo "âœ… **Release Build Completed Successfully**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **Test Build Completed Successfully**" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Details" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Organization | ${ORGANIZATION} |" >> $GITHUB_STEP_SUMMARY
          echo "| Source Repository | ${{ github.event.inputs.source_repo }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Source Ref | ${{ github.event.inputs.ref }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ github.event.inputs.release_version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Type | ${{ github.event.inputs.is_release == 'true' && 'ðŸš€ Release' || 'ðŸ§ª Test' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit SHA | ${{ steps.source_info.outputs.commit_sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event.inputs.is_release }}" == "true" ]; then
            echo "### âœ… Actions Taken" >> $GITHUB_STEP_SUMMARY
            echo "- Built binaries for all platforms" >> $GITHUB_STEP_SUMMARY
            echo "- Created GitHub release" >> $GITHUB_STEP_SUMMARY
            echo "- Generated krew manifest" >> $GITHUB_STEP_SUMMARY
            echo "- Created PR to ${ORGANIZATION}/${{ vars.KREW_INDEX_REPO_NAME || 'krew-index' }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "1. ðŸ“ Review and merge the PR in krew-index repository" >> $GITHUB_STEP_SUMMARY
            echo "2. ðŸŽ‰ Users can install/update via:" >> $GITHUB_STEP_SUMMARY
            echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "   kubectl krew index add ${ORGANIZATION} https://github.com/${ORGANIZATION}/${{ vars.KREW_INDEX_REPO_NAME || 'krew-index' }}.git" >> $GITHUB_STEP_SUMMARY
            echo "   kubectl krew install ${ORGANIZATION}/cnpg" >> $GITHUB_STEP_SUMMARY
            echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… Actions Taken" >> $GITHUB_STEP_SUMMARY
            echo "- Built binaries for all platforms" >> $GITHUB_STEP_SUMMARY
            echo "- Created test release (marked as pre-release)" >> $GITHUB_STEP_SUMMARY
            echo "- âš ï¸ **No PR created** (test build only)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "1. ðŸ§ª Download and test the binaries" >> $GITHUB_STEP_SUMMARY
            echo "2. âœ… If tests pass, trigger a **release build** to create the krew PR" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
          echo "- [View Release](${{ steps.create_release.outputs.url }})" >> $GITHUB_STEP_SUMMARY

