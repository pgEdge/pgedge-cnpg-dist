name: E2E Tests

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      cluster_providers:
        description: 'Cluster providers (comma-separated, e.g., "kind,eks")'
        required: false
        default: 'kind'
        type: string
      cnpg_versions:
        description: 'CNPG versions (comma-separated, e.g., "1.28.0,1.27.1" or "all")'
        required: false
        default: 'all'
        type: string
      k8s_versions:
        description: 'Kubernetes versions (comma-separated, e.g., "1.32,1.33" or "all")'
        required: false
        default: 'all'
        type: string
      test_types:
        description: 'Test types (comma-separated, e.g., "infra,operator" or "all")'
        required: false
        default: 'all'
        type: string
      postgres_version:
        description: 'PostgreSQL version (e.g., "18", "17", "16" or empty for default)'
        required: false
        default: ''
        type: string

# Default filters for PR/push (only Kind, all versions/tests)
# workflow_dispatch inputs override these
env:
  CLUSTER_PROVIDERS: ${{ inputs.cluster_providers || 'kind' }}
  CNPG_VERSIONS: ${{ inputs.cnpg_versions || 'all' }}
  K8S_VERSIONS: ${{ inputs.k8s_versions || 'all' }}
  TEST_TYPES: ${{ inputs.test_types || 'all' }}
  POSTGRES_VERSION: ${{ inputs.postgres_version || '' }}

jobs:
  # Single job for image validation test
  test-image-validation:
    name: Image Validation Policy
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install dependencies
        run: |
          go mod download
          go install github.com/onsi/ginkgo/v2/ginkgo@latest

      - name: Set up Kind
        uses: helm/kind-action@v1
        with:
          install_only: true

      - name: Run image validation test
        run: make test-image-validation
        env:
          CLUSTER_PROVIDER: kind
          NODE_COUNT: 3

  # Generate test matrix from versions.yaml
  generate-matrix:
    name: Generate Test Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Generate matrix from versions.yaml
        id: set-matrix
        run: |
          # Generate full matrix from versions.yaml
          # Iterates over: cnpg_versions -> providers -> k8s versions -> test types
          full_matrix=$(yq eval -o=json '
            .cnpg_versions[] |
            .version as $cnpg |
            .providers | to_entries[] |
            {
              "cnpg_version": $cnpg,
              "provider": .key,
              "k8s_versions": .value.kubernetes_versions
            } |
            . as $item |
            $item.k8s_versions[] |
            {
              "cnpg_version": $item.cnpg_version,
              "provider": $item.provider,
              "k8s_version": .,
              "test_type": ["comprehensive", "infra", "operator"]
            } |
            .test_type[] as $test |
            {
              "cnpg_version": .cnpg_version,
              "provider": .provider,
              "k8s_version": .k8s_version,
              "test_type": $test
            }
          ' tests/config/versions.yaml | jq -s .)

          # Build filter arrays from env vars (handle "all" as no filter)
          if [ "$CLUSTER_PROVIDERS" = "all" ]; then
            providers_filter="null"
          else
            providers_filter=$(echo "$CLUSTER_PROVIDERS" | tr ',' '\n' | jq -R . | jq -s .)
          fi

          if [ "$CNPG_VERSIONS" = "all" ]; then
            cnpg_filter="null"
          else
            cnpg_filter=$(echo "$CNPG_VERSIONS" | tr ',' '\n' | jq -R . | jq -s .)
          fi

          if [ "$K8S_VERSIONS" = "all" ]; then
            k8s_filter="null"
          else
            k8s_filter=$(echo "$K8S_VERSIONS" | tr ',' '\n' | jq -R . | jq -s .)
          fi

          if [ "$TEST_TYPES" = "all" ]; then
            test_filter="null"
          else
            test_filter=$(echo "$TEST_TYPES" | tr ',' '\n' | jq -R . | jq -s .)
          fi

          # Apply all filters (null means no filter for that field)
          matrix=$(echo "$full_matrix" | jq -c \
            --argjson providers "$providers_filter" \
            --argjson cnpg "$cnpg_filter" \
            --argjson k8s "$k8s_filter" \
            --argjson tests "$test_filter" \
            '[.[] |
              select(($providers == null) or (.provider as $p | $providers | index($p))) |
              select(($cnpg == null) or (.cnpg_version as $v | $cnpg | index($v))) |
              select(($k8s == null) or (.k8s_version as $v | $k8s | index($v))) |
              select(($tests == null) or (.test_type as $t | $tests | index($t)))
            ]')

          echo "matrix={\"include\":$matrix}" >> $GITHUB_OUTPUT

          # Print for debugging
          echo "Filters applied:"
          echo "  CLUSTER_PROVIDERS: $CLUSTER_PROVIDERS"
          echo "  CNPG_VERSIONS: $CNPG_VERSIONS"
          echo "  K8S_VERSIONS: $K8S_VERSIONS"
          echo "  TEST_TYPES: $TEST_TYPES"
          echo "Matrix entries: $(echo "$matrix" | jq length)"
          echo "$matrix" | jq .

  # Filter matrix for Kind-only jobs (PR/push events)
  filter-kind-matrix:
    name: Filter Kind Matrix
    runs-on: ubuntu-latest
    needs: generate-matrix
    outputs:
      matrix: ${{ steps.filter.outputs.matrix }}
      has_jobs: ${{ steps.filter.outputs.has_jobs }}
    steps:
      - name: Filter matrix for Kind provider
        id: filter
        run: |
          full_matrix='${{ needs.generate-matrix.outputs.matrix }}'
          # Filter to only Kind jobs
          kind_matrix=$(echo "$full_matrix" | jq -c '{include: [.include[] | select(.provider == "kind")]}')
          job_count=$(echo "$kind_matrix" | jq '.include | length')
          echo "matrix=$kind_matrix" >> $GITHUB_OUTPUT
          if [ "$job_count" -gt 0 ]; then
            echo "has_jobs=true" >> $GITHUB_OUTPUT
          else
            echo "has_jobs=false" >> $GITHUB_OUTPUT
          fi
          echo "Filtered to $job_count Kind jobs"

  # Matrix job for Kind comprehensive, infrastructure and operator tests
  kind-test-matrix:
    name: kind / ${{ matrix.cnpg_version }} / K8s ${{ matrix.k8s_version }} / ${{ matrix.test_type }}
    runs-on: ubuntu-24.04-x64
    needs: filter-kind-matrix
    if: needs.filter-kind-matrix.outputs.has_jobs == 'true'
    timeout-minutes: 120
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.filter-kind-matrix.outputs.matrix) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install dependencies
        run: |
          go mod download
          go install github.com/onsi/ginkgo/v2/ginkgo@latest

      - name: Set up Kind
        uses: helm/kind-action@v1
        with:
          install_only: true

      - name: Run smoke test
        if: matrix.test_type == 'smoke'
        run: make test-smoke
        env:
          CLUSTER_PROVIDER: kind
          KUBERNETES_VERSION: ${{ matrix.k8s_version }}
          NODE_COUNT: 3
          CNPG_VERSION: ${{ matrix.cnpg_version }}
          POSTGRES_VERSION: ${{ env.POSTGRES_VERSION }}

      - name: Run infrastructure test
        if: matrix.test_type == 'infra'
        run: make test-infra
        env:
          CLUSTER_PROVIDER: kind
          KUBERNETES_VERSION: ${{ matrix.k8s_version }}
          NODE_COUNT: 3
          CNPG_VERSION: ${{ matrix.cnpg_version }}
          POSTGRES_VERSION: ${{ env.POSTGRES_VERSION }}

      - name: Run comprehensive test
        if: matrix.test_type == 'comprehensive'
        run: make test-comprehensive
        env:
          CLUSTER_PROVIDER: kind
          KUBERNETES_VERSION: ${{ matrix.k8s_version }}
          NODE_COUNT: 3
          CNPG_VERSION: ${{ matrix.cnpg_version }}
          POSTGRES_VERSION: ${{ env.POSTGRES_VERSION }}

      - name: Run operator test
        if: matrix.test_type == 'operator'
        run: make test-operator
        env:
          CLUSTER_PROVIDER: kind
          KUBERNETES_VERSION: ${{ matrix.k8s_version }}
          NODE_COUNT: 3
          CNPG_VERSION: ${{ matrix.cnpg_version }}
          POSTGRES_VERSION: ${{ env.POSTGRES_VERSION }}

      - name: Cleanup
        if: always()
        run: |
          kind delete cluster --name cnpg-smoke-test 2>/dev/null || true
          kind delete cluster --name cnpg-infra-test 2>/dev/null || true
          kind delete cluster --name cnpg-operator-test 2>/dev/null || true

  # Filter matrix for EKS jobs (workflow_dispatch only)
  filter-eks-matrix:
    name: Filter EKS Matrix
    runs-on: ubuntu-latest
    needs: generate-matrix
    if: github.event_name == 'workflow_dispatch' && contains(inputs.cluster_providers, 'eks')
    outputs:
      matrix: ${{ steps.filter.outputs.matrix }}
      has_jobs: ${{ steps.filter.outputs.has_jobs }}
    steps:
      - name: Filter matrix for EKS provider
        id: filter
        run: |
          full_matrix='${{ needs.generate-matrix.outputs.matrix }}'
          # Filter to only EKS jobs
          eks_matrix=$(echo "$full_matrix" | jq -c '{include: [.include[] | select(.provider == "eks")]}')
          job_count=$(echo "$eks_matrix" | jq '.include | length')
          echo "matrix=$eks_matrix" >> $GITHUB_OUTPUT
          if [ "$job_count" -gt 0 ]; then
            echo "has_jobs=true" >> $GITHUB_OUTPUT
          else
            echo "has_jobs=false" >> $GITHUB_OUTPUT
          fi
          echo "Filtered to $job_count EKS jobs"

  # Matrix job for EKS tests (only via workflow_dispatch)
  eks-test-matrix:
    name: eks / ${{ matrix.cnpg_version }} / K8s ${{ matrix.k8s_version }} / ${{ matrix.test_type }}
    runs-on: ubuntu-latest
    needs: filter-eks-matrix
    if: needs.filter-eks-matrix.outputs.has_jobs == 'true'
    timeout-minutes: 180
    strategy:
      fail-fast: false
      max-parallel: 1  # EKS clusters are expensive, run one at a time
      matrix: ${{ fromJson(needs.filter-eks-matrix.outputs.matrix) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION || 'us-west-2' }}

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5"
          terraform_wrapper: false

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install dependencies
        run: |
          go mod download
          go install github.com/onsi/ginkgo/v2/ginkgo@latest

      - name: Run smoke test
        if: matrix.test_type == 'smoke'
        run: make test-smoke
        env:
          CLUSTER_PROVIDER: eks
          KUBERNETES_VERSION: ${{ matrix.k8s_version }}
          NODE_COUNT: 3
          AWS_REGION: ${{ secrets.AWS_REGION || 'us-west-2' }}
          CNPG_VERSION: ${{ matrix.cnpg_version }}
          POSTGRES_VERSION: ${{ env.POSTGRES_VERSION }}
          EKS_USE_SPOT: "true"

      - name: Run infrastructure test
        if: matrix.test_type == 'infra'
        run: make test-infra
        env:
          CLUSTER_PROVIDER: eks
          KUBERNETES_VERSION: ${{ matrix.k8s_version }}
          NODE_COUNT: 3
          AWS_REGION: ${{ secrets.AWS_REGION || 'us-west-2' }}
          CNPG_VERSION: ${{ matrix.cnpg_version }}
          POSTGRES_VERSION: ${{ env.POSTGRES_VERSION }}
          EKS_USE_SPOT: "true"

      - name: Run comprehensive test
        if: matrix.test_type == 'comprehensive'
        run: make test-comprehensive
        env:
          CLUSTER_PROVIDER: eks
          KUBERNETES_VERSION: ${{ matrix.k8s_version }}
          NODE_COUNT: 3
          AWS_REGION: ${{ secrets.AWS_REGION || 'us-west-2' }}
          CNPG_VERSION: ${{ matrix.cnpg_version }}
          POSTGRES_VERSION: ${{ env.POSTGRES_VERSION }}
          EKS_USE_SPOT: "true"

      - name: Run operator test
        if: matrix.test_type == 'operator'
        run: make test-operator
        env:
          CLUSTER_PROVIDER: eks
          KUBERNETES_VERSION: ${{ matrix.k8s_version }}
          NODE_COUNT: 3
          AWS_REGION: ${{ secrets.AWS_REGION || 'us-west-2' }}
          CNPG_VERSION: ${{ matrix.cnpg_version }}
          POSTGRES_VERSION: ${{ env.POSTGRES_VERSION }}
          EKS_USE_SPOT: "true"

      - name: Cleanup EKS cluster
        if: always()
        run: |
          cd tests/terraform/eks
          terraform destroy -auto-approve || true
        env:
          AWS_REGION: ${{ secrets.AWS_REGION || 'us-west-2' }}

  # Summary job that requires all matrix jobs to pass
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-image-validation, kind-test-matrix, eks-test-matrix]
    if: always()
    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.test-image-validation.result }}" != "success" ]; then
            echo "Image validation test failed"
            exit 1
          fi
          # Kind tests are required (unless skipped because no Kind jobs in matrix)
          if [ "${{ needs.kind-test-matrix.result }}" != "success" ] && [ "${{ needs.kind-test-matrix.result }}" != "skipped" ]; then
            echo "Kind matrix tests failed"
            exit 1
          fi
          # EKS tests are optional (only run via workflow_dispatch with eks provider)
          if [ "${{ needs.eks-test-matrix.result }}" == "failure" ]; then
            echo "EKS matrix tests failed"
            exit 1
          fi
          echo "All tests passed!"
