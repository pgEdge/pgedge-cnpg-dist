# Version matrix for CNPG E2E testing
# This file defines which versions to test and on which providers

cnpg_versions:
  - version: "1.28.1"
    chart_version: "0.27.1"
    git_tag: "v1.28.1"
    operator_image: "ghcr.io/pgedge/cloudnative-pg:1.28.1"
    postgres_versions: ["18", "17", "16"]
    providers:
      kind:
        kubernetes_versions: ["1.32", "1.33", "1.34"]

  - version: "1.27.3"
    chart_version: "0.27.1"
    git_tag: "v1.27.1"
    operator_image: "ghcr.io/pgedge/cloudnative-pg:1.27.1"
    postgres_versions: ["18", "17", "16"]
    providers:
      kind:
        kubernetes_versions: ["1.31", "1.32", "1.33"]

# PostgreSQL image configuration
# Images from: https://github.com/pgedge/postgres-images
postgres_images:
  # Image registries
  # Use POSTGRES_IMAGE_REGISTRY environment variable to switch between public and internal
  registries:
    public:
      name: "pgedge-postgres"
      base: "ghcr.io/pgedge/pgedge-postgres"
      description: "Public release images"
      url: "https://github.com/pgEdge/postgres-images/pkgs/container/pgedge-postgres"
    internal:
      name: "pgedge-postgres-internal"
      base: "ghcr.io/pgedge/pgedge-postgres-internal"
      description: "Internal pre-release images for testing"
      url: "https://github.com/pgEdge/postgres-images/pkgs/container/pgedge-postgres-internal"

  # Default registry to use (can override with POSTGRES_IMAGE_REGISTRY=internal)
  default_registry: "public"

  # Spock version (included in image tags)
  spock_version: "spock5"

  # Image variants to test
  variants:
    - name: "minimal"
      tag_suffix: "-minimal"
      description: "Minimal PostgreSQL image with core functionality"
    - name: "standard"
      tag_suffix: "-standard"
      description: "Standard PostgreSQL image with common extensions"

# Test execution defaults
test_defaults:
  # Default test features to run (can be overridden via CLI)
  feature_type: "smoke"
  # Available feature types: smoke, basic, security, backup-restore, snapshot,
  # operator, observability, replication, etc.

  # Test depth level (0 = critical only, 4 = all tests)
  test_depth: 0

  # Parallel execution settings
  parallel:
    enabled: true
    max_workers: 3  # Max number of parallel test runs

  # Storage class configuration (mirrors CNPG defaults)
  storage:
    default_class: "csi-hostpath-sc"
    csi_class: "csi-hostpath-sc"
    snapshot_class: "csi-hostpath-snapclass"

# Kind cluster defaults
kind_defaults:
  image: "kindest/node:v1.32.0"
  nodes: 3
  networking:
    service_subnet: "10.21.0.0/16"
    pod_subnet: "10.20.0.0/16"
  storage:
    default_class: "csi-hostpath-sc"
    csi_class: "csi-hostpath-sc"
    snapshot_class: "csi-hostpath-snapclass"

# Kubernetes version-specific configuration
# Each K8s version defines its own set of manifests for cluster setup
# Used for CSI drivers, storage, monitoring, and any other version-specific components
kubernetes_versions:

  "1.34":
    manifests:
      - name: "Volume Snapshot CRDs"
        url: "https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/v8.4.0/client/config/crd/snapshot.storage.k8s.io_volumesnapshotclasses.yaml"
      - name: "Volume Snapshot Contents CRDs"
        url: "https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/v8.4.0/client/config/crd/snapshot.storage.k8s.io_volumesnapshotcontents.yaml"
      - name: "Volume Snapshots CRDs"
        url: "https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/v8.4.0/client/config/crd/snapshot.storage.k8s.io_volumesnapshots.yaml"
      - name: "Snapshot Controller RBAC"
        url: "https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/v8.4.0/deploy/kubernetes/snapshot-controller/rbac-snapshot-controller.yaml"
      - name: "Snapshot Controller Setup"
        url: "https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/v8.4.0/deploy/kubernetes/snapshot-controller/setup-snapshot-controller.yaml"
      - name: "External Provisioner RBAC"
        url: "https://raw.githubusercontent.com/kubernetes-csi/external-provisioner/v6.1.0/deploy/kubernetes/rbac.yaml"
      - name: "External Attacher RBAC"
        url: "https://raw.githubusercontent.com/kubernetes-csi/external-attacher/v4.10.0/deploy/kubernetes/rbac.yaml"
      - name: "External Resizer RBAC"
        url: "https://raw.githubusercontent.com/kubernetes-csi/external-resizer/v2.0.0/deploy/kubernetes/rbac.yaml"
      - name: "CSI Hostpath Driver"
        url: "https://raw.githubusercontent.com/kubernetes-csi/csi-driver-host-path/v1.17.0/deploy/kubernetes-1.30/hostpath/csi-hostpath-driverinfo.yaml"
      - name: "CSI Hostpath Plugin"
        url: "https://raw.githubusercontent.com/kubernetes-csi/csi-driver-host-path/v1.17.0/deploy/kubernetes-1.30/hostpath/csi-hostpath-plugin.yaml"

  "1.33":
    manifests:
      - name: "Volume Snapshot CRDs"
        url: "https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/v8.4.0/client/config/crd/snapshot.storage.k8s.io_volumesnapshotclasses.yaml"
      - name: "Volume Snapshot Contents CRDs"
        url: "https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/v8.4.0/client/config/crd/snapshot.storage.k8s.io_volumesnapshotcontents.yaml"
      - name: "Volume Snapshots CRDs"
        url: "https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/v8.4.0/client/config/crd/snapshot.storage.k8s.io_volumesnapshots.yaml"
      - name: "Snapshot Controller RBAC"
        url: "https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/v8.4.0/deploy/kubernetes/snapshot-controller/rbac-snapshot-controller.yaml"
      - name: "Snapshot Controller Setup"
        url: "https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/v8.4.0/deploy/kubernetes/snapshot-controller/setup-snapshot-controller.yaml"
      - name: "External Provisioner RBAC"
        url: "https://raw.githubusercontent.com/kubernetes-csi/external-provisioner/v6.1.0/deploy/kubernetes/rbac.yaml"
      - name: "External Attacher RBAC"
        url: "https://raw.githubusercontent.com/kubernetes-csi/external-attacher/v4.10.0/deploy/kubernetes/rbac.yaml"
      - name: "External Resizer RBAC"
        url: "https://raw.githubusercontent.com/kubernetes-csi/external-resizer/v2.0.0/deploy/kubernetes/rbac.yaml"
      - name: "CSI Hostpath Driver"
        url: "https://raw.githubusercontent.com/kubernetes-csi/csi-driver-host-path/v1.17.0/deploy/kubernetes-1.30/hostpath/csi-hostpath-driverinfo.yaml"
      - name: "CSI Hostpath Plugin"
        url: "https://raw.githubusercontent.com/kubernetes-csi/csi-driver-host-path/v1.17.0/deploy/kubernetes-1.30/hostpath/csi-hostpath-plugin.yaml"

  "1.32":
    manifests:
      - name: "Volume Snapshot CRDs"
        url: "https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/v8.4.0/client/config/crd/snapshot.storage.k8s.io_volumesnapshotclasses.yaml"
      - name: "Volume Snapshot Contents CRDs"
        url: "https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/v8.4.0/client/config/crd/snapshot.storage.k8s.io_volumesnapshotcontents.yaml"
      - name: "Volume Snapshots CRDs"
        url: "https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/v8.4.0/client/config/crd/snapshot.storage.k8s.io_volumesnapshots.yaml"
      - name: "Snapshot Controller RBAC"
        url: "https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/v8.4.0/deploy/kubernetes/snapshot-controller/rbac-snapshot-controller.yaml"
      - name: "Snapshot Controller Setup"
        url: "https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/v8.4.0/deploy/kubernetes/snapshot-controller/setup-snapshot-controller.yaml"
      - name: "External Provisioner RBAC"
        url: "https://raw.githubusercontent.com/kubernetes-csi/external-provisioner/v6.1.0/deploy/kubernetes/rbac.yaml"
      - name: "External Attacher RBAC"
        url: "https://raw.githubusercontent.com/kubernetes-csi/external-attacher/v4.10.0/deploy/kubernetes/rbac.yaml"
      - name: "External Resizer RBAC"
        url: "https://raw.githubusercontent.com/kubernetes-csi/external-resizer/v2.0.0/deploy/kubernetes/rbac.yaml"
      - name: "CSI Hostpath Driver"
        url: "https://raw.githubusercontent.com/kubernetes-csi/csi-driver-host-path/v1.17.0/deploy/kubernetes-1.30/hostpath/csi-hostpath-driverinfo.yaml"
      - name: "CSI Hostpath Plugin"
        url: "https://raw.githubusercontent.com/kubernetes-csi/csi-driver-host-path/v1.17.0/deploy/kubernetes-1.30/hostpath/csi-hostpath-plugin.yaml"

  "1.31":
    manifests:
      - name: "Volume Snapshot CRDs"
        url: "https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/v8.4.0/client/config/crd/snapshot.storage.k8s.io_volumesnapshotclasses.yaml"
      - name: "Volume Snapshot Contents CRDs"
        url: "https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/v8.4.0/client/config/crd/snapshot.storage.k8s.io_volumesnapshotcontents.yaml"
      - name: "Volume Snapshots CRDs"
        url: "https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/v8.4.0/client/config/crd/snapshot.storage.k8s.io_volumesnapshots.yaml"
      - name: "Snapshot Controller RBAC"
        url: "https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/v8.4.0/deploy/kubernetes/snapshot-controller/rbac-snapshot-controller.yaml"
      - name: "Snapshot Controller Setup"
        url: "https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/v8.4.0/deploy/kubernetes/snapshot-controller/setup-snapshot-controller.yaml"
      - name: "External Provisioner RBAC"
        url: "https://raw.githubusercontent.com/kubernetes-csi/external-provisioner/v6.1.0/deploy/kubernetes/rbac.yaml"
      - name: "External Attacher RBAC"
        url: "https://raw.githubusercontent.com/kubernetes-csi/external-attacher/v4.10.0/deploy/kubernetes/rbac.yaml"
      - name: "External Resizer RBAC"
        url: "https://raw.githubusercontent.com/kubernetes-csi/external-resizer/v2.0.0/deploy/kubernetes/rbac.yaml"
      - name: "CSI Hostpath Driver"
        url: "https://raw.githubusercontent.com/kubernetes-csi/csi-driver-host-path/v1.17.0/deploy/kubernetes-1.30/hostpath/csi-hostpath-driverinfo.yaml"
      - name: "CSI Hostpath Plugin"
        url: "https://raw.githubusercontent.com/kubernetes-csi/csi-driver-host-path/v1.17.0/deploy/kubernetes-1.30/hostpath/csi-hostpath-plugin.yaml"

  "1.30":
    manifests:
      - name: "Volume Snapshot CRDs"
        url: "https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/v8.4.0/client/config/crd/snapshot.storage.k8s.io_volumesnapshotclasses.yaml"
      - name: "Volume Snapshot Contents CRDs"
        url: "https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/v8.4.0/client/config/crd/snapshot.storage.k8s.io_volumesnapshotcontents.yaml"
      - name: "Volume Snapshots CRDs"
        url: "https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/v8.4.0/client/config/crd/snapshot.storage.k8s.io_volumesnapshots.yaml"
      - name: "Snapshot Controller RBAC"
        url: "https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/v8.4.0/deploy/kubernetes/snapshot-controller/rbac-snapshot-controller.yaml"
      - name: "Snapshot Controller Setup"
        url: "https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/v8.4.0/deploy/kubernetes/snapshot-controller/setup-snapshot-controller.yaml"
      - name: "External Provisioner RBAC"
        url: "https://raw.githubusercontent.com/kubernetes-csi/external-provisioner/v6.1.0/deploy/kubernetes/rbac.yaml"
      - name: "External Attacher RBAC"
        url: "https://raw.githubusercontent.com/kubernetes-csi/external-attacher/v4.10.0/deploy/kubernetes/rbac.yaml"
      - name: "External Resizer RBAC"
        url: "https://raw.githubusercontent.com/kubernetes-csi/external-resizer/v2.0.0/deploy/kubernetes/rbac.yaml"
      - name: "CSI Hostpath Driver"
        url: "https://raw.githubusercontent.com/kubernetes-csi/csi-driver-host-path/v1.17.0/deploy/kubernetes-1.30/hostpath/csi-hostpath-driverinfo.yaml"
      - name: "CSI Hostpath Plugin"
        url: "https://raw.githubusercontent.com/kubernetes-csi/csi-driver-host-path/v1.17.0/deploy/kubernetes-1.30/hostpath/csi-hostpath-plugin.yaml"

# Default K8s version to use if specific version not found
default_kubernetes_version: "1.34"

# pgEdge Helm chart test defaults
pgedge_helm:
  cert_manager_version: "v1.19.3"
  cert_manager_manifest: "https://github.com/cert-manager/cert-manager/releases/download/v1.19.3/cert-manager.yaml"
  default_values: "examples/configs/single/values.yaml"
  init_spock_image: "pgedge-helm-utils:dev"
